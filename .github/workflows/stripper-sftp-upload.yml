name: Upload Changed Stripper CFGs via SFTP (Server 1)

on:
  push:
    branches:
      - main
    paths:
      - 'addons/sourcemod/configs/stripper/**/*.cfg'

env:
  DRY_RUN: true   # set to false to actually upload

jobs:
  upload-changed-stripper-cfgs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Get list of changed .cfg files
        id: changed_files
        run: |
          echo "Changed .cfg files in the last commit:"
          git fetch --depth=2
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'addons/sourcemod/configs/stripper/**/*.cfg')
          echo "$CHANGED"
          echo "::set-output name=files::$CHANGED"

      - name: Dry run - show changed files
        if: env.DRY_RUN == 'true'
        run: |
          echo "Dry run mode - these files would be uploaded:"
          echo "${{ steps.changed_files.outputs.files }}"

      - name: Upload changed .cfg files via SFTP
        if: env.DRY_RUN == 'false' && steps.changed_files.outputs.files != ''
        run: |
          for FILE in ${{ steps.changed_files.outputs.files }}; do
            echo "Uploading $FILE..."
            lftp -u "${{ secrets.SFTP_USER1 }},${{ secrets.SFTP_PASSWORD1 }}" \
              -p ${{ secrets.SFTP_PORT1 }} \
              sftp://${{ secrets.SFTP_HOST1 }} <<EOF
            set sftp:auto-confirm yes
            put -O ${{ secrets.SFTP_TARGET1 }} "$FILE"
            bye
            EOF
          done
