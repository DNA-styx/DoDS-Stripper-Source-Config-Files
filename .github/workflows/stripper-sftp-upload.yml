name: Upload Stripper CFGs via SFTP (Server 1)

on:
  push:
    branches:
      - main
    paths:
      - 'addons/sourcemod/configs/stripper/**/*.cfg'

env:
  DRY_RUN: false   # set to false when ready to actually upload

jobs:
  upload-stripper-cfgs-server1:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: List .cfg files that would be uploaded
        run: |
          echo "Dry run mode: $DRY_RUN"
          echo "Files detected locally:"
          find addons/sourcemod/configs/stripper \
            -maxdepth 2 \
            -type f \
            -name "*.cfg" \
            -print

      - name: Upload to Sever 1 (US)
        if: env.DRY_RUN == 'false'
        run: |
          echo "Uploading .cfg files to SFTP server..."
          lftp -u "${{ secrets.SFTP_USER1 }},${{ secrets.SFTP_PASSWORD1 }}" \
            -p ${{ secrets.SFTP_PORT1 }} \
            sftp://${{ secrets.SFTP_HOST1 }} <<EOF
          set sftp:auto-confirm yes
          set net:timeout 10
          set net:max-retries 2
          set net:reconnect-interval-base 5
          set cmd:fail-exit yes
          mirror -R \
            --only-newer \
            --include-glob=*.cfg \
            --include-glob=*/\*.cfg \
            --depth-first \
            addons/sourcemod/configs/stripper \
            ${{ secrets.SFTP_TARGET1 }}
          bye
          EOF

      - name: Upload to Server 2 (EU)
        if: env.DRY_RUN == 'false'
        run: |
          lftp -u "${{ secrets.SFTP_USER2 }},${{ secrets.SFTP_PASSWORD2 }}" \
            -p ${{ secrets.SFTP_PORT2 }} \
            sftp://${{ secrets.SFTP_HOST2 }} <<EOF
          set sftp:auto-confirm yes
          set net:timeout 10
          set net:max-retries 2
          set net:reconnect-interval-base 5
          set cmd:fail-exit yes
          mirror -R \
            --only-newer \
            --include-glob=*.cfg \
            --include-glob=*/\*.cfg \
            --depth-first \
            addons/sourcemod/configs/stripper \
            ${{ secrets.SFTP_TARGET2 }}
          bye
          EOF

      - name: Upload to Server 3 (AU)
        if: env.DRY_RUN == 'false'
        run: |
          lftp -u "${{ secrets.SFTP_USER3 }},${{ secrets.SFTP_PASSWORD3 }}" \
            -p ${{ secrets.SFTP_PORT3 }} \
            sftp://${{ secrets.SFTP_HOST3 }} <<EOF
          set sftp:auto-confirm yes
          set net:timeout 10
          set net:max-retries 2
          set net:reconnect-interval-base 5
          set cmd:fail-exit yes
          mirror -R \
            --only-newer \
            --include-glob=*.cfg \
            --include-glob=*/\*.cfg \
            --depth-first \
            addons/sourcemod/configs/stripper \
            ${{ secrets.SFTP_TARGET3 }}
          bye
          EOF
